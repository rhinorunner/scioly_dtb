This code should hae everything but still needs testing.
